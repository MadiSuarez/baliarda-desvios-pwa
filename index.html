<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Baliarda ‚Äì Buscador de Desv√≠os (Piloto)</title>
  <meta name="theme-color" content="#0b4b3f" />
  <style>
    :root { --bg:#0b4b3f; --card:#0f5a4c; --text:#ffffff; --muted:#cfe7e1; --line:rgba(255,255,255,.15); }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg); color: var(--text); }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    .brand { display:flex; align-items:center; justify-content:center; padding: 18px 0 6px; }
    .brand h1 { margin:0; font-size: 34px; letter-spacing:.5px; }
    .searchRow { display:flex; gap:10px; align-items:center; margin: 14px 0 10px; }
    input[type="text"]{ flex:1; font-size:18px; padding:14px 14px; border-radius: 999px; border:0; outline:none; }
    button { border:0; border-radius: 999px; padding: 12px 16px; font-size:16px; cursor:pointer; }
    .btn { background: #e8f5f2; color:#0b4b3f; font-weight:600; }
    .btn2 { background: rgba(255,255,255,.15); color: var(--text); }
    .pill { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius: 999px; border:1px solid var(--line); color: var(--muted); font-size: 13px; }
    .status { width:28px; text-align:center; font-size:18px; }
    .card { background: rgba(255,255,255,.06); border:1px solid var(--line); border-radius: 16px; overflow:hidden; }
    .row { display:flex; gap:10px; align-items:flex-start; padding: 12px 12px; border-top:1px solid var(--line); cursor:pointer; }
    .row:first-child{ border-top:0; }
    .left { flex:1; min-width:0; }
    .line1 { display:flex; gap:10px; align-items:baseline; flex-wrap:wrap; }
    .clip { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .muted { color: var(--muted); }
    .mono { font-variant-numeric: tabular-nums; }
    .right { display:flex; align-items:center; gap:10px; padding-left: 8px; }
    .folder { width: 28px; text-align:center; font-size:18px; opacity:.95; }
    .badge { border:1px solid var(--line); border-radius: 10px; padding: 3px 8px; font-size: 12px; color: var(--muted); }
    .detail { display:none; padding: 12px 12px 14px 50px; border-top: 1px solid var(--line); background: rgba(0,0,0,.06); }
    .kv { display:grid; grid-template-columns: 160px 1fr; gap: 6px 12px; font-size:14px; }
    .k { color: var(--muted); }
    .v { word-break: break-word; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top: 8px; flex-wrap:wrap; }
    .small { font-size:13px; color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <h1>Baliarda</h1>
    </div>

    <div class="searchRow">
      <input id="q" type="text" placeholder="Buscar por ID, Lote/Entrada o Descripci√≥n (ej. Lustona 48A)" />
      <button class="btn" id="btnBuscar">Buscar</button>
    </div>

    <div class="topbar">
      <span class="pill">üóÇÔ∏è Desv√≠os ‚Äì Piloto (solo lectura)</span>
      <span class="small" id="meta">Cargando‚Ä¶</span>
    </div>

    <div style="height:10px"></div>
    <div class="card" id="list"></div>
  </div>

<script>
 const API_URL = "https://script.google.com/macros/s/AKfycbyL32dMcoRGPCZut4ZbT_WVOa0suPGvgtbdHJZBQzVRsUGTksPzGpSldKaNFeFbj4qntA/exec";

  let DATA = [];

  function statusIcon(estadoNorm){
    if (estadoNorm === "APROBADO") return "‚úÖ";
    if (estadoNorm === "RECHAZADO") return "‚ùå";
    return "‚ö†Ô∏è";
  }

  // Regla lote 48 ‚Üî 48A:
  // - si query es "48A": exacto 48A primero (lo hace el sort por match)
  // - si query es "48": acepta 48 y 48A/48B... (mismo n√∫mero + letra)
  function loteMatches(query, lote){
    const q = query.trim().toUpperCase();
    const l = String(lote || "").trim().toUpperCase();
    if (!q || !l) return false;

    // exacto
    if (l === q) return true;

    // si query es solo n√∫mero (ej "48") aceptar "48A" pero no "481"
    if (/^\d+$/.test(q) && new RegExp("^" + q + "[A-Z]$").test(l)) return true;

    return false;
  }

  function looksLikeID(s){
    // simple: num√©rico o alfanum corto sin espacios
    const t = s.trim();
    if (!t) return false;
    if (t.includes(" ")) return false;
    return /^[A-Za-z0-9\-_/]+$/.test(t) && t.length <= 18;
  }

  function matches(record, query){
    const q = query.trim().toUpperCase();
    if (!q) return true;

    const id = String(record.id || "").toUpperCase();
    const desc = String(record.descripcion || "").toUpperCase();
    const lote = String(record.lote || "").toUpperCase();
    const evento = String(record.evento || "").toUpperCase();

    // si el usuario pone algo tipo "48A" o "48"
    if (loteMatches(q, lote)) return true;

    // match exacto por ID / evento si el token parece c√≥digo
    if (looksLikeID(q) && (id === q || evento === q)) return true;

    // b√∫squeda por contiene en descripci√≥n
    if (desc.includes(q)) return true;

    // b√∫squeda por contiene en lote (pero NO para evitar 45 vs 451)
    // solo permitir contiene si el query termina con letra (48A) o el lote es exacto
    if (/^\d+[A-Z]$/.test(q) && lote.includes(q)) return true;

    return false;
  }

  function render(list){
    const el = document.getElementById("list");
    el.innerHTML = "";

    if (!list.length){
      el.innerHTML = `<div class="row" style="cursor:default"><div class="left muted">Sin resultados.</div></div>`;
      return;
    }

    list.forEach((r, idx) => {
      const rowId = `r_${idx}`;
      const detId = `d_${idx}`;

      const fecha = r.fechaTexto || "";
      const desc = r.descripcion || "";

      const html = `
        <div>
          <div class="row" id="${rowId}">
            <div class="folder">üóÇÔ∏è</div>
            <div class="left">
              <div class="line1">
                <span class="badge mono">${r.evento || ""}</span>
                <span class="badge mono">${r.id || ""}</span>
                <span class="clip">${desc}</span>
                <span class="badge mono">${r.lote || ""}</span>
                <span class="badge mono">${fecha}</span>
              </div>
            </div>
            <div class="right">
              <div class="status" title="${r.estadoNorm}">${statusIcon(r.estadoNorm)}</div>
            </div>
          </div>
          <div class="detail" id="${detId}">
            <div class="kv">
              <div class="k">C√≥digo / Evento</div><div class="v mono">${r.evento || ""}</div>
              <div class="k">Producto</div><div class="v">${r.descripcion || ""}</div>
              <div class="k">ID</div><div class="v mono">${r.id || ""}</div>
              <div class="k">Lote/Entrada</div><div class="v mono">${r.lote || ""}</div>
              <div class="k">Estado</div><div class="v">${statusIcon(r.estadoNorm)} ${r.estadoRaw || ""}</div>
              <div class="k">Fecha</div><div class="v mono">${fecha}</div>
              <div class="k">T√≠tulo desv√≠o</div><div class="v">${r.tituloDesvio || ""}</div>
              <div class="k">Decisi√≥n lotes</div><div class="v">${r.decisionLotes || ""}</div>
              <div class="k">Causa</div><div class="v">${r.causa || ""}</div>
              <div class="k">Resp. GC</div><div class="v">${r.respGC || ""}</div>
            </div>
          </div>
        </div>
      `;
      el.insertAdjacentHTML("beforeend", html);

      document.getElementById(rowId).addEventListener("click", () => {
        const d = document.getElementById(detId);
        d.style.display = (d.style.display === "block") ? "none" : "block";
      });
    });
  }

  function applySearch(){
    const q = document.getElementById("q").value || "";
    const filtered = DATA.filter(r => matches(r, q));
    render(filtered);
    document.getElementById("meta").textContent = `Resultados: ${filtered.length} / ${DATA.length} (ordenado por fecha desc)`;
  }

function load() {
  const meta = document.getElementById("meta");
  meta.textContent = "Cargando datos‚Ä¶";

  const cbName = "handleData_" + Date.now();
  const sep = API_URL.includes("?") ? "&" : "?";
  const src = `${API_URL}${sep}callback=${cbName}&nocache=${Date.now()}`;

  const t = setTimeout(() => {
    meta.textContent = "Timeout cargando datos. URL: " + src;
  }, 8000);

  window[cbName] = (json) => {
    clearTimeout(t);
    try {
      DATA = (json && json.data) ? json.data : [];
      DATA.sort((a,b) => (b.fechaISO || "").localeCompare(a.fechaISO || ""));
      render(DATA);
      meta.textContent = `Registros: ${DATA.length} (ordenado por fecha desc)`;
    } finally {
      delete window[cbName];
      script.remove();
    }
  };

  const script = document.createElement("script");
  script.src = src;
  script.async = true;

  script.onerror = () => {
    clearTimeout(t);
    meta.textContent = "Error cargando script. URL: " + src;
    script.remove();
    delete window[cbName];
  };

  document.body.appendChild(script);
}



  document.getElementById("btnBuscar").addEventListener("click", applySearch);
  document.getElementById("q").addEventListener("keydown", (e) => {
    if (e.key === "Enter") applySearch();
  });

  load();
</script>
</body>
</html>




